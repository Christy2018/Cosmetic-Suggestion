<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Cosmetic AI</title>
    
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../static/css/dashboard.css">
</head>
<body>
    <header>
        <div class="logo">Cosmetic Care</div>
    </header>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">User Dashboard</div>
            <nav>
                <ul>
                    <li><a href="#" class="sidebar-link active" data-section="test-analyse">Test & Analyse</a></li>
                    <li><a href="#" class="sidebar-link" data-section="user-history">User History</a></li>
                    <li><a href="#" class="sidebar-link" data-section="blogs">Blogs</a></li>
                    <li><a href="/auth/logout" id="logoutButton">Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Test & Analyse Section -->
            <section id="test-analyse" class="section active">
                <h2 class="text-center">Test & Analyse Your Skin</h2>
                <div class="analysis-container">
                    <div class="image-upload mb-3">
                        <label for="skin-image-upload" class="form-label">Upload Skin Image:</label>
                        <input type="file" id="skin-image-upload" class="form-control" accept="image/*">
                        <div id="image-preview" class="mt-3"></div>
                    </div>
                    <button id="analyse-button" class="btn btn-primary mt-3">Analyse</button>
                </div>
                <div id="analysis-results" class="mt-4">
                    <div id="findings" class="mb-3">
                        <h3>Findings</h3>
                        <div id="findings-content"></div>
                    </div>
                    <div id="recommendations">
                        <h3>Recommendations</h3>
                        <div id="recommendations-content"></div>
                    </div>
                </div>
                <h3 class="mt-4">Leave a Review for the Prediction</h3>
                <form id="review-form" class="mb-4">
                    <div class="mb-3">
                        <textarea id="review-text" class="form-control" placeholder="Write your review here..." rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating:</label>
                        <select id="rating" class="form-select w-auto d-inline-block" required>
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
                <div id="review-message" class="text-success"></div>
                <h3>Reviews</h3>
                <div id="reviews-container" class="mt-3">
                    <!-- Reviews will be dynamically loaded here -->
                </div>
            </section>

            <!-- User History Section -->
            <section id="user-history" class="section">
                <h2>Your Skin History</h2>
                <p>Track your skin's progress and past analyses.</p>
                <table id="history-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Prediction</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- History data will be dynamically loaded here -->
                    </tbody>
                </table>
            </section>

            <!-- Blogs Section -->
            <section id="blogs" class="section">
                <h2>Skincare Insights</h2>
                <p>Discover expert tips and the latest trends.</p>
                <div id="blogs-list">
                    <!-- Blogs will be dynamically loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../static/js/dashboard.js"></script>
    <script>
        // Sidebar Navigation
        document.querySelectorAll(".sidebar-link").forEach(link => {
            link.addEventListener("click", function (event) {
                event.preventDefault();

                // Remove active class from all links
                document.querySelectorAll(".sidebar-link").forEach(l => l.classList.remove("active"));

                // Add active class to the clicked link
                this.classList.add("active");

                // Hide all sections
                document.querySelectorAll(".section").forEach(section => section.classList.remove("active"));

                // Show the target section
                const target = document.querySelector(`#${this.dataset.section}`);
                if (target) {
                    target.classList.add("active");
                } else {
                    console.error(`Section not found for data-section: ${this.dataset.section}`);
                }
            });
        });

        // Logout Functionality
        document.getElementById("logoutButton").addEventListener("click", async function (event) {
            event.preventDefault();
            try {
                const response = await fetch("/auth/logout", { method: "GET" });
                if (response.ok) {
                    window.location.href = "/auth/login";
                } else {
                    alert("Logout failed. Try again.");
                }
            } catch (error) {
                console.error("Logout error:", error);
            }
        });

        async function fetchUserHistory() {
            try {
                const response = await fetch("/api/user_history");
                const history = await response.json();
                console.log("Fetched user history:", history);

                const historyTableBody = document.querySelector("#history-table tbody");
                historyTableBody.innerHTML = ""; // Clear existing history

                if (history.length === 0) {
                    historyTableBody.innerHTML = "<tr><td colspan='3'>No history found.</td></tr>";
                    return;
                }

                history.forEach(entry => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${entry.date}</td>
                        <td>${entry.prediction}</td>
                        <td><a href="${entry.recommendation}" target="_blank">View Recommendation</a></td>
                    `;
                    historyTableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching user history:", error);
            }
        }

        // Call fetchUserHistory when the "User History" section is loaded
        document.querySelector("[data-section='user-history']").addEventListener("click", fetchUserHistory);
    </script>
</body>
</html>
